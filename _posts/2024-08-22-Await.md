---
title: Await
date: 2024-08-22 16:20:32 +0200
categories: [C#]
tags: [multithreading, task]
---

To understand `await/async` try to debug  the  following code. 
You will see that `await`  imply call for method getawaiter of class  that implemented INotifyCompletion.  

 <https://github.com/dotnet/roslyn/blob/main/src/Compilers/CSharp/Test/Semantic/Semantics/BindingAwaitTests.cs>

```csharp
public class AwaitTests
{
    [Fact]
    static async void AwaitTest()
    {
        var r = await new A();
        Assert.Equal(r, 4);
        r = await new B();
        Assert.Equal(r, 7);
    }


    class A
    {
        internal Boo GetAwaiter()
        {
            return new Boo();
        }
    }

    class B : System.Runtime.CompilerServices.INotifyCompletion
    {
        private int a = default;

        internal B GetAwaiter()
        {
            OnCompleted(() => { a = 5; });
            return this;
        }

        public void OnCompleted(Action x)
        {
            x.Invoke();
        }

        public int GetResult()
        {
            return a + 2;
        }

        public bool IsCompleted
        {
            get
            {
                return false; //call OnCompleted  with action `void MoveNext()`
            }
        }
    }


    class Boo : System.Runtime.CompilerServices.INotifyCompletion
    {
        private int a = default;

        public void OnCompleted(Action x)
        {
            x.Invoke();
        }

        public int GetResult()
        {
            return a + 2;
        }

        public bool IsCompleted
        {
            get
            {
                a = 2;
                return true;
            }
        }
    }
}

```
